name: Nifty 50 EMA Alerts Cron

on:
  schedule:
    # Run every 5 minutes during market hours (9:15 AM to 3:30 PM IST)
    # This is in UTC, so IST 9:15 AM = UTC 3:45 AM
    - cron: '*/5 4-10 * * 1-5'  # Monday to Friday, 4:00 AM to 10:00 AM UTC (9:30 AM to 3:30 PM IST)
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-alerts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config file
      run: |
        cat > config.json << EOF
        {
          "upstox": {
            "client_id": "${{ secrets.UPSTOX_API_KEY }}",
            "client_secret": "${{ secrets.UPSTOX_API_SECRET }}",
            "redirect_uri": "https://nifty50-ema-alerts.netlify.app/.netlify/functions/auth"
          },
          "telegram": {
            "bot_token": "${{ secrets.TELEGRAM_BOT_TOKEN }}",
            "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}"
          }
        }
        EOF
        
    - name: Create token file
      run: |
        cat > upstox_refresh.json << EOF
        {
          "access_token": "${{ secrets.UPSTOX_ACCESS_TOKEN }}"
        }
        EOF
        
    - name: Run EMA Alert Check
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from upstox_client import UpstoxClient
        from telegram_bot import TelegramBot
        import json
        
        # Load config
        with open('config.json') as f:
            config = json.load(f)
            
        # Initialize clients
        upstox = UpstoxClient(config['upstox'])
        telegram = TelegramBot(config['telegram']['bot_token'], config['telegram']['chat_id'])
        
        try:
            # Check for EMA signals
            data = upstox.get_nifty_data()
            if data and len(data) >= 5:
                ema = upstox.calculate_ema(data, 5)
                current_price = data[-1]['close']
                
                if current_price > ema:
                    message = f'ğŸš€ <b>BULLISH EMA SIGNAL</b>\n\n'
                    message += f'ğŸ“Š <b>Nifty 50:</b> â‚¹{current_price:,.2f}\n'
                    message += f'ğŸ“ˆ <b>EMA(5):</b> â‚¹{ema:,.2f}\n'
                    message += f'ğŸ”¥ <b>Signal:</b> BULLISH\n\n'
                    message += f'â° <b>Time:</b> {data[-1][\"datetime\"]}'
                    
                    telegram.send_alert(message)
                    print(f'âœ… Bullish signal sent: â‚¹{current_price:,.2f} > EMA â‚¹{ema:,.2f}')
                else:
                    print(f'ğŸ’¤ No bullish signal: â‚¹{current_price:,.2f} <= EMA â‚¹{ema:,.2f}')
            else:
                print('âš ï¸ Insufficient data for EMA calculation')
        except Exception as e:
            print(f'âŒ Error: {e}')
            telegram.send_alert(f'âš ï¸ Alert system error: {str(e)}')
        "
